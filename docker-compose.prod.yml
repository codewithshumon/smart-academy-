version: "3.8"

services:
    # Frontend (Next.js)
    frontend:
        build:
            context: ./frontend
            dockerfile: Dockerfile.prod
        container_name: smart_academy_frontend
        restart: unless-stopped
        ports:
            - "3000:3000"
        environment:
            - NODE_ENV=production
        networks:
            - smart_academy_network
        depends_on:
            - backend

    # Backend (Express.js)
    backend:
        build:
            context: ./backend
            dockerfile: Dockerfile.prod
        container_name: smart_academy_backend
        restart: unless-stopped
        ports:
            - "5000:5000"
        environment:
            - NODE_ENV=production
            - DATABASE_URL=postgresql://smart_admin:${DB_PASSWORD}@postgres:5432/smart_academy
            - REDIS_HOST=redis
            - REDIS_PORT=6379
            - ELASTICSEARCH_NODE=http://elasticsearch:9200
        networks:
            - smart_academy_network
        depends_on:
            postgres:
                condition: service_healthy
            redis:
                condition: service_healthy
            elasticsearch:
                condition: service_healthy

    # PostgreSQL Database
    postgres:
        image: postgres:16-alpine
        container_name: smart_academy_postgres
        restart: unless-stopped
        environment:
            POSTGRES_USER: smart_admin
            POSTGRES_PASSWORD: ${DB_PASSWORD}
            POSTGRES_DB: smart_academy
        volumes:
            - postgres_prod_data:/var/lib/postgresql/data
        networks:
            - smart_academy_network
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U smart_admin"]
            interval: 10s
            timeout: 5s
            retries: 5

    # Redis Cache
    redis:
        image: redis:7-alpine
        container_name: smart_academy_redis
        restart: unless-stopped
        command: redis-server --requirepass ${REDIS_PASSWORD}
        volumes:
            - redis_prod_data:/data
        networks:
            - smart_academy_network
        healthcheck:
            test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
            interval: 10s
            timeout: 5s
            retries: 5

    # Elasticsearch
    elasticsearch:
        image: elasticsearch:8.11.0
        container_name: smart_academy_elasticsearch
        restart: unless-stopped
        environment:
            - discovery.type=single-node
            - xpack.security.enabled=true
            - ELASTIC_PASSWORD=${ELASTIC_PASSWORD}
            - "ES_JAVA_OPTS=-Xms2g -Xmx2g"
        volumes:
            - elasticsearch_prod_data:/usr/share/elasticsearch/data
        networks:
            - smart_academy_network
        healthcheck:
            test:
                [
                    "CMD-SHELL",
                    "curl -u elastic:${ELASTIC_PASSWORD} -f http://localhost:9200/_cluster/health || exit 1",
                ]
            interval: 30s
            timeout: 10s
            retries: 5

    # Nginx Reverse Proxy
    nginx:
        image: nginx:alpine
        container_name: smart_academy_nginx
        restart: unless-stopped
        ports:
            - "80:80"
            - "443:443"
        volumes:
            - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
            - ./docker/nginx/ssl:/etc/nginx/ssl:ro
        networks:
            - smart_academy_network
        depends_on:
            - frontend
            - backend

volumes:
    postgres_prod_data:
        driver: local
    redis_prod_data:
        driver: local
    elasticsearch_prod_data:
        driver: local

networks:
    smart_academy_network:
        driver: bridge
